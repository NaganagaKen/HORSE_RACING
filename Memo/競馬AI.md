# 競馬AIメモ

## 特徴量

| 変数名(変換前)         | 変数名(変換後)       | 型     | 説明                                                                                                                                  | 欠損            |
|------------------------|----------------------|--------|---------------------------------------------------------------------------------------------------------------------------------------|-----------------|
| レースID(新)           | race_id              | int    | yearを作成するために取り込み +00～03:年(4byte), +04,05:月, +06,07:日, +08,09:場所コード, +10,11:回次, +12,13:日次, +14,15:レース番号, +16,17:馬番号 | なし            |
| 年                     | year                 | int    | 2桁表記をrace_idを使用して4桁に上書き                                                                                               | なし            |
| 月                     | month                | int    | 月                                                                                                                                    | なし            |
| 日                     | day                  | int    | 日                                                                                                                                    | なし            |
| 回次                   | times                | int    | 何回目の開催か                                                                                                                        | なし            |
| 場所                   | place                | chr    | 開催場所                                                                                                                              | なし            |
| 日次                   | daily                | chr    | 開催の何日目か(1,2,3,…,9,A,B,C)                                                                                                       | なし            |
| レース番号             | race_num             | int    | 何レース目か                                                                                                                          | なし            |
| 馬名                   | horse                | chr    | 馬名, 馬のid代わり                                                                                                                    | なし            |
| 騎手コード             | jockey_id            | int    | 騎手id                                                                                                                                | なし            |
| 頭数                   | horse_N              | int    | 出馬数                                                                                                                                | なし            |
| 枠番                   | waku_num             | int    | 枠番                                                                                                                                  | なし            |
| 馬番                   | horse_num            | int    | 馬番                                                                                                                                  | なし            |
| クラスコード           | class_code           | int    | レースの種類（G1など）                                                                                                                | なし            |
| トラックコード(JV)    | track_code           | int    | 後でトラックコードから変換                                                                                                            | なし            |
| コーナー回数           | corner_num           | int    | コースのコーナー回数                                                                                                                  | 欠損率3.3%、2で埋め |
| 距離                   | dist                 | int    | コースの距離                                                                                                                          | なし            |
| 馬場状態               | state                | chr    | コースの状態                                                                                                                          | なし            |
| 天候                   | weather              | chr    | 天候                                                                                                                                | なし            |
| 年齢限定(競走種別コード) | age_code             | int    | 競走種別コード（詳細不明）                                                                                                            | なし            |
| 性別                   | sex                  | chr    | 牡、牝、騙馬                                                                                                                          | なし            |
| 年齢                   | age                  | int    | 年齢                                                                                                                                | なし            |
| 斤量                   | basis_weight         | num    | 出走時の負担重量                                                                                                                      | なし            |
| ブリンカー             | blinker              | chr    | ブリンカーフラグ                                                                                                                      | なし            |
| 馬体重                 | weight               | int    | 馬体重                                                                                                                              | 欠損率0.26%、平均埋め |
| 増減                   | inc_dec              | int    | 馬体重の増減                                                                                                                          | 欠損率9.1%、0埋め |
| 重量コード             | weight_code          | int    | 重量負荷種別                                                                                                                          | なし            |
| 単勝オッズ             | win_odds             | num    | 確定単勝オッズ                                                                                                                        | —               |
| 確定着順               | rank                 | int    | 確定順位                                                                                                                              | なし            |
| 着差タイム             | time_diff            | chr    | 「---」は取消など、1着は2着とのタイム差をマイナス値                                                                                 | なし            |
| 走破タイム(秒)         | time                 | num    | 走破タイム                                                                                                                            | なし            |
| 通過順1角              | corner1_rank         | int    | 1コーナー順位、0は欠損                                                                                                                | 0は使用しない   |
| 通過順2角              | corner2_rank         | int    | 2コーナー順位、0は欠損                                                                                                                | 0は使用しない   |
| 通過順3角              | corner3_rank         | int    | 3コーナー順位、0は欠損                                                                                                                | 0は使用しない   |
| 通過順4角              | corner4_rank         | int    | 4コーナー順位、0は欠損                                                                                                                | 0は使用しない   |
| 上がり3Fタイム         | last_3F_time         | num    | 最後600mの走破タイム                                                                                                                  | 欠損率0.9%      |
| 上がり3F順位           | last_3F_rank         | int    | 最後600mでの順位                                                                                                                      | 欠損率3.4%      |
| Ave-3F                | Ave_3F               | num    | ラスト3Fまでの平均タイム                                                                                                              | 欠損率4%        |
| PCI                   | PCI                  | num    | ペースチェンジ指数                                                                                                                    | 欠損率4%        |
| -3F差                 | last_3F_time_diff    | num    | ゴール前3Fのタイム差                                                                                                                  | 欠損率4%        |
| 脚質                   | leg                  | chr    | レースの走り方                                                                                                                        | なし            |
| 人気                   | pop                  | int    | 人気順位（error_code = 0では欠損なし）                                                                                                | —               |
| 賞金                   | prize                | int    | 獲得賞金                                                                                                                              | なし            |
| 異常コード             | error_code           | int    | 0=正常, 1=出走取消, 2=発送除外, 3=競走除外, 4=競走中止, 5=失格, 6=落馬再騎乗, 7=降着                                                 | なし            |
| 父馬名                 | father               | chr    | 父馬名                                                                                                                                | なし            |
| 母馬名                 | mother               | chr    | 母馬名                                                                                                                                | なし            |
| 血統登録番号           | id                   | int    | 馬id（10桁）                                                                                                                           | なし            |

### 追加した特徴量
| 変数名 | 型 | 説明|
| --- | --- | --- |
| id_for_fold | category | fold用の特徴量、レースを一意に識別する |
| field_type | str | 芝・ダート・サンド・芝ダートのいずれか |
| flat_or_jump | str | 平地・障害のいずれか |
| turn_type | str | L（左周り）・R（右回り）・S（直線）|
| race_type | str | 場所/コース/距離, 例）阪神芝1200|
| waku | str | "inner"（内枠） または "outer"（外枠） |
| datetime | datetime64 | レースの日付 |
| target | int | 1着なら1、それ以外なら0|
| target3 | int | 1~3着なら1, それ以外なら0 |


## EDA で気になったこと


### メモ
#### EDA後で見る事
- 月ごとにどのような階級のレースが行われているのか
- 年月日から何曜日開催が多いのか
- 各horse_Nでどのようなレース種別が多いのか
- 各horse_Nはどの月に多いのか
- 距離と競馬場の組み合わせがどこなのか調べる
- horse_Nが小さいレースはどのようなものがあるか（どのような種別？）
  - オッズの付き方に特徴があるか調べる。
- レース前に分かる情報は何か調べる。
- あとでデータサイエンス研究会のdriveにあるサンプルを見てみる。


#### 一般メモ
  - ["waku_num", "horse_num", "sex", "age", "basis_weight", "blinker", "weight", "inc_dec"]がNo feature engineeringで使った特徴量
  - n_trialsは100-300くらいがちょうどいいかも500は明らかにやりすぎ
  - horse_Nを特徴量に追加したり、モデルをhorse_Nで分けるのは意味ない。データ数が少ないから汎化性能が低そう。
  - Netkeibaの指標は以下の通り
    - タイム指数（計算方法は不明、恐らく西田式？？？）https://race.netkeiba.com/race/speed.html?race_id=202505021209&rf=shutuba_submenu
    - 会場・芝orダート・距離ごとの分析https://race.netkeiba.com/race/data_top.html?race_id=202505021209&rf=race_submenu
      - コースで有利な枠順
      - 有利な脚質
      - 得意な騎手
      - 得意な調教師
      - 実績がある種牡馬
      - 実績がある母父
- error_codeの取り扱い
  - 1のデータは使用せずに学習させる。

#### 疑問点


## これからやること
- 特徴量エンジニアリング
- ドメイン知識の収集
  - プロの馬券師や競馬新聞はどのようにしてマークを付けているのかを調べる。　
  - 競馬場、距離、枠番号で傾向がある可能性あり。過去データから傾向を調べる。
- 欠損値の意味をよく考える。
  - 欠損値そのものが予測に影響を与える可能性がある。（出走取消）
- 当日情報が簡単に手に入らないものは特徴量として考えない。
  - 体重・体重増減など？
- prizeは累積の可能性がある。(JVデータにはなさそう)
- test_data_JVの確認
  - どの特徴量が予測に使えて、どの特徴量が使えないか吟味する。
  - modelから予測できるか必ず確認する。
  - 今のところ、corner_numをどうにかすれば大丈夫そう
- 生産者を追加する。

この順番で特徴量エンジニアリングをやればよさそう！！！
- 脚質、コーナー通過順、Ave-3F, PCI, RPCI, last-3f-time, last-3f-time-diff
  - 他の特徴量も予測できないか要件等
- リーク情報などを予測して埋め込む
  - PCI
  - RPCI
  - Ave_3F
  - last_3F_time_diff
  - last_3F_time
    - ここからlast_3F_rankを計算する。
  - コーナー通過順
    - 過去レースの結果から特徴量の埋め込み
      - 脚質傾向（過去どの脚質が何回選択されたかを計算し、正規化する）
      - 過去の各馬のレースにおいて、同じ枠番号・馬番・会場・距離・クラスコード・トラックコード・馬場等で、どんなコーナー通過順になっていたか
      - 過去全てのレースにおいて、同じ枠番号・馬番・会場・距離・クラスコード・トラックコード・馬場等で、どんなコーナー通過順になっていたか
    - 予測したPCI, Ave-3Fなどの情報も使う
  - 脚質
    - 脚質はコーナー通過順から決まるものとした方がよさそう
    - http://www.keiba-lab.jp/exp/up/d_1106.html
  - その他 (PCI, Ave-3Fなど)
- oddsの予測（労力の割には大した成果がなさそう）
  - https://logmi.jp/main/technology/330672
    - ターゲットを確定オッズではなく支持率にする
      - 確定オッズにすると、予測値が負になる可能性がある。
      - オッズ = 払戻率（控除率）/ 支持率
    - 特徴量エンジニアリング
      - 血統ベクトルの計算(https://qiita.com/KTaskn/items/e76551191214593c278e)
      - 順位の平均

### 6/30やること
- [済] isotonic キャリブレーションを実施（画像）
- [済] Elo Rating と Glicko2を埋め込み（馬と騎手の両方を計算）
- [済] 各レーティングの上昇度を特徴量として追加し、EloRatingの上昇度を用いてグルーピング(calc_group_rating)を行う
- [済] 過去に選択した脚質の累積和を計算（出走回数で割り正規化する）
  - 出走回数も追加しておく
- [済] 距離を短距離、マイル、中距離、長距離に分類（SMILE）
  - これで特徴量を作ってみる
- [済] prizeの累積和をfatherで計算（リーディングザイアーを計算）
  - うまく行ったらmotherやboodmaresireでも計算してみる
- [済] optunaの目的関数を訂正（不均衡（勝ち馬 1 : 負け馬 N-1）も相まって「勝ち馬を外すペナルティが相対的に小さい」という問題が起きやすいので重みづけを行う）(済)
- [済] レーティング同士の相互作用特徴量を計算
- [済] 各馬の使っていないリーク情報の平均を計算（クラスコードなどでグループ化して計算してみる）
  - 平均着差
  - 平均タイム差


### 7/2 やること
- [済] model_tunerの調整（重みづけがちゃんと機能しているかよく確認）
  - ((1 / horse_N) ** alpha) * (beta**y_i)としてやったが、効果なし（betaが1になるような調整を行ってしまう）
  - キャリブレーションカーブも大幅悪化
  - 恐らく重み付けそのものがノイズになってしまっている
- [済] 多クラス分類(1, 2, 3着とそれ以外)用のlightGBMモデルを作成
  - チューニングが一回で終わるが、分かりにくい
  - 1着, 2着, 3着, 連対, 複勝を別のモデルで予測するようにする。
    - こちらは馬の勝率の合計が1にならない。

### 7/5やること
- [済] 2008年からのオッズ情報を全てダウンロード->まとめる
  - 馬連のデータ量が多すぎるので、馬連のみ2024-2025までに変更
- [済] model_tuner_multiの修復
- [済] cold start問題の解決の為に、最初2年分のデータを学習データから削除
  - 全体のloglossが0.002だけ改善
- [済] extra trees
  - 追加してもよさそう
- [済] 特徴量選択
  - lightGBMによる選択
    - 200までに制限しても大丈夫そう（汎化性能は向上したっぽい）
    - 学習時間も短縮されたし、できるなら採用したい
    - 他の特徴量選択方法も試したい
- [済] fold増やす
  - 変化なし
- [済] n_trials増やす
  - 400まで増やした。効果なし。
- [済] early_stopping_round増やす
  - 200まで上げたげど変化なし。学習時間の観点から切り捨てる
- [済] distとplaceを特徴量として追加

### 7/7やること
- [済] TrueSkill, Glicko2, Elo Ratingをfeatures.pyから分離して、計算済の辞書を予測で使えるようにする。
  - [済] TrueSkill
  - [済] Glicko2
  - [済] Elo Rating
- [済] 枠連買ってみる
  - 一レースずつ実際に資金をかけて、移動量をプロットしてみる。
  - 資金はケリー基準を用いて、増減した分から賭ける。
  - 結果として、最初のレースで大量に馬券を買ってしまい、負ける
  - 恐らくまだ性能が足りない。

### 7/17までにやる事
- [済] 枠連の確率の計算方法をもう少し考える。


### 次の集会（8/6?）までにやっておくこと
- [済] 日付の追加 (year, month, day, dayofweek, cosもそれぞれ追加)
- [済] 季節 (season)を追加
- [ ] Glicko2の計算方法を変える（他のライブラリを用いる）
- [ ] TrueSkillの平均を出す関数(calc_grouped_rating)をやめる
- [ ] grouped_winning_rateを用いた特徴量を増やす（特に以下の特徴量を用いて増やす）
  - trainer_id
  - owner
  - breeding_farm
  - breeding_place
  - season

### いつかやること
- [ ] 2008年度からの単勝、複勝オッズをダウンロードして、整理する。
- [ ] 2008年度からのデータを使って学習させてみる。
- [ ] 複勝のオッズとそのランキング特徴量を追加
- [ ] OpenSkillを追加
- [ ] float64をfloat32にしてメモリを節約する。 
- [ ] 特徴量選択の方法をもう少しロバストにする（パラメータチューニングをちゃんとやる） 
- [ ] feature_colの重複がないようにsetにするか重複時にエラーが出るようにする。
- [ ] jockey_idでもGlicko2を計算できるようにする。
- [ ] DeepLearningとのスタッキング
- [ ] 血統ベクトルの追加（nord2vecかFastTextか、あるいは両方）
  - [ ] ベクトルをUMAPでまとめて、k-meansを実行(エルボー法)
- [ ] glicko2が不安定なので直す（他のライブラリ使う）


### 特徴量エンジニアリング（案）
- rank=0の列をnp.nanに変えるか、異常コードが0以外の馬を学習データ(X_train)から外す
- time_diffを使いたいなら、前処理しないといけない
  - 特に取り消しをどう処理するべきか調べる
- [済] 過去、同じ母父の馬がどのような成績だったのかを特徴量として加える。
- [済] 過去の平均順位（class_codeごとに作ったりする）
- [済] 今回のレースが、今までで一番位が高いレースか
  - あまり重要ではなかったので、除外した
- targetの作り方に注意（rankが0は欠損値（異常終了））
- **恐らくレースごとにグループに分けて、そのグループの中で正規化しなければいけない**
  - レースで大事なのは、絶対的な強さではなく、相対的な強さ
- リークとなる列をモデルで予測して、その値を元に特徴量を作る。
- Glicko2のジョッキーの特徴量を追加できなかったので、追加する
  - 恐らくインストールしたモジュールの問題なので、モジュール自体を変更する


### うまく行かなかった特徴量エンジニアリング
- mother, fatherなどの重要そうなカテゴリデータは全部繋げてtf-idfでベクトル化する（多様性があまりない？）
- 年月日曜（cosも含む）をそのまま入れる
  - ただ、日付や季節を用いた特徴量エンジニアリングは効きそう


### 馬券購入戦略メモ
- ケリー基準を用いる
  - ケリー基準の中でも、分散ケリー等のより負担が少ない戦略を用いる
### Target frontier JVメモ
- 当日の情報は出馬表->出馬表分析から得る
  - ★１
  - 画面が表示されたら、F10(オッズ読み込み) -> F8(出力) -> 一覧・★画面イメージCSV形式出力
- オッズを一括ダウンロード
- オッズ情報は、たまーにレース全体でNanのときがあるから注意（JV-linkのエラー？）

## 定例会メモ
- 5/8 Thu.
  - 確率ならloglossを使って検証する。
  - 1着かそれ以外かで2値分類
    - 頭数で確率が大きく変わるので、工夫が必要。頭数を使って考える。
  - 単勝の確定オッズを予測して、それを使って戦略を立てたい。（TimeSeriesOddsから予測する） 
    - 確定オッズは馬券販売終了後に確定するからリークになってしまう。
  - 最適レートについて調べる。（馬券の購入方法として重要らしい）

5/15
  - EDAをちゃんとやるべき

5/22
  - EDAをちゃんとやったので、モデルを作成
  - 適宜モデリングをしていくこと。

6/5
  - オッズを予測するべき
    - 直前5分前オッズからとりあえず予測するとか？

6/12
  - ケリー基準を使って予測する。
  - 時系列オッズの取得方法を佐野先生に送っていただいたので確認。

6/19
  - オッズ予測の方法をもう少し考える
  - 脚質は元データのものと、コーナー通過角から得られた脚質をもとに予測する。

6/26
  - 単勝の期待値が1を超える馬のみでキャリブレーションカーブを描くと、均等線の下をカーブが移動してしまう（画像）
  - 勝率を過大評価しているから期待値が1を超えてしまう？
  - 勝率の高い馬を過大評価しているのではなく、勝率の低い馬を過小評価している？
  - 修正案
    - [済] キャリブレーション -> キャリブレーションカーブの改善がみられる?（画像）
    - [済] 学習時にhorse_Nの逆数で重み付けを行う（不均衡データへの対処）
      - 逆に悪化->重みづけそのものがノイズになっている可能性がある
    - [ ] スタッキング
      - NN（キャリブレーション必須）-> 時間がかかるとまずい(5秒以内)
      - ロジスティック回帰 -> 簡単使いやすい
    - [済] データ数を増やす
      - 今は2020年~2025年のデータしか使ってない
      - なぜか昔のデータを使うとloglossが悪化（オッズが与えられていなかったから？）

7/3
  - 他のキャリブレーションの方法を考える。(ロジスティック回帰)
  - 定性的な分析をする（評価指標（スコア）を出す）
  - targetで開催成績CSVからデータを出力してやると3代以上前の血統がみられる可能性がある。
  


# 疑問点
- マルチクラス分類では、レース内で勝利確率を正規化するのと、1, 2, 3着, 着外で確率を正規化するのは同時に行えないがどうすればいいのか（レース内で、縦にも横にも足して1にすることができない。）
- 2020-2025年のデータと、2008-2025年までのデータでは、どちらを使うべきか。
- optunaの目的関数では、レース内で正規化する前のloglossを最小化するようしているが、これで合っているのか？
- 枠連の計算方法はあっているか？
- 1着確率から馬連を計算してもいいか

# その他情報共有
- nord2vecで血統を表現